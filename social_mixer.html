<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿ∫ÿ±ŸÅÿ© ÿßŸÑÿ≥Ÿàÿ¥ŸäÿßŸÑ ŸÖŸäÿØŸäÿß | Social Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; }

        body {
            font-family: 'Tajawal', sans-serif;
            background: #000;
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; align-items: center; justify-content: center;
            /* ‚úÖ ÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑŸÖÿ≥ÿßÿ±: ÿ•ÿ≤ÿßŸÑÿ© / ŸÖŸÜ ÿßŸÑÿ®ÿØÿßŸäÿ© */
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.7)),
                        url('static/images/social_background.jpg') no-repeat center center fixed;
            background-size: cover;
        }

        .home-btn {
            position: absolute; top: 30px; left: 30px;
            text-decoration: none; color: #fff;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px; border-radius: 30px;
            display: flex; align-items: center; gap: 10px;
            font-weight: bold; font-family: 'Tajawal', sans-serif;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: 0.3s; z-index: 2000; backdrop-filter: blur(5px);
        }
        .home-btn:hover {
            background: rgba(255, 255, 255, 0.2); transform: scale(1.05);
            text-decoration: none; color: #fff; border-color: #2ecc71;
        }

        .glass-panel {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid #333; border-radius: 12px;
            width: 90%; max-width: 1100px; padding: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); position: relative;
        }

        .header-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; position: relative; z-index: 60;
        }
        /* ‚úÖ ÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑŸÖÿ≥ÿßÿ± */
        .app-logo img { height: 55px; }
        .version-badge {
            background: #333; color: #888;
            padding: 6px 15px; border-radius: 15px;
            font-size: 0.9rem; border: 1px solid #444;
        }

        .inputs-row {
            display: flex; gap: 30px; margin-bottom: 25px;
            direction: ltr !important;
            position: relative; z-index: 50; width: 100%;
        }
        .input-group { flex: 1; text-align: left; position: relative; }

        .input-label {
            display: block; color: #ccc; font-size: 0.95rem;
            font-weight: 800; text-transform: uppercase; margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .dark-input {
            width: 100%; background: #111; border: 1px solid #444; color: #fff;
            padding: 15px 20px; border-radius: 8px;
            font-family: 'Tajawal', sans-serif; font-size: 1rem; font-weight: bold;
            outline: none; transition: 0.3s; cursor: pointer;
            display: flex; align-items: center; justify-content: space-between;
            direction: ltr;
        }
        .dark-input:hover { border-color: #2ecc71; background: #1a1a1a; }
        .dark-input select {
            background: transparent; border: none; color: white; width: 100%;
            font-family: 'Tajawal'; font-size: 1rem; font-weight: bold;
            cursor: pointer; outline: none; appearance: none;
        }
        .dark-input select option { background-color: #1a1a1a; color: white; padding: 15px; }
        #fileNameDisplay { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; direction: ltr; text-align: left; }

        .editor-container {
            width: 100%; height: 500px; background: #050505;
            border: 2px dashed #333; border-radius: 10px;
            display: none; overflow: hidden; position: relative; margin-bottom: 25px;
            z-index: 1;
        }

        .welcome-msg {
            text-align: center; color: #555; padding: 70px;
            border: 2px dashed #333; border-radius: 10px; font-size: 1.2rem;
        }

        .cropper-face { background-color: transparent !important; opacity: 1 !important; }
        .overlay-ghost {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50; pointer-events: none !important; opacity: 0.85 !important; display: block;
        }
        .cropper-view-box { outline: 2px solid #2ecc71; }
        .cropper-modal { opacity: 0.6; background-color: #000; }
        .cropper-dashed, .cropper-line { display: none !important; }
        .cropper-point { width: 10px; height: 10px; background-color: #2ecc71; opacity: 0.9; }

        /* Blur Circle */
        #blur-circle {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 100px; height: 100px;
            border-radius: 50%; border: 2px dashed rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            background: rgba(255, 255, 255, 0.1); cursor: grab; z-index: 10000;
            display: none; box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #blur-circle:active { cursor: grabbing; border-color: #e67e22; }
        #blur-circle::after {
            content: "‚úñ"; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); color: rgba(255,255,255,0.6);
            font-size: 20px; font-weight: bold; pointer-events: none;
        }

        .footer-row { margin-top: 10px; position: relative; z-index: 50; }
        .filename-container { direction: ltr !important; text-align: left !important; margin-bottom: 15px; width: 100%; }
        .filename-container .input-label { text-align: left; }
        .filename-container .dark-input { direction: ltr; text-align: left; width: 100%; }

        .buttons-container { display: flex; gap: 15px; margin-top: 15px; direction: ltr; }

        .action-btn {
            background: #e0e0e0; color: #000; font-weight: 900;
            padding: 16px; border: none; border-radius: 8px; font-size: 1.1rem;
            cursor: pointer; transition: 0.3s; text-transform: uppercase;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .action-btn:hover { background: #fff; transform: translateY(-2px); }
        .action-btn:disabled { background: #333; color: #555; cursor: not-allowed; transform: none; }

        .reset-btn { background: #c0392b; color: white; flex: 1; }
        .reset-btn:hover { background: #e74c3c; }
        .download-btn { flex: 3; }

        .blur-controls {
            display: flex; gap: 10px; margin-bottom: 15px; justify-content: flex-end;
            direction: ltr; align-items: center;
        }
        .blur-btn {
            background: #333; color: #ccc; border: 1px solid #555;
            padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;
            font-size: 0.9rem; transition: 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .blur-btn:hover { background: #444; color: white; }
        .blur-btn.active { background: #e67e22; color: white; border-color: #e67e22; }

        .intensity-slider-group {
            display: flex; align-items: center; gap: 10px; color: #ccc;
            background: #222; padding: 5px 15px; border-radius: 20px;
            border: 1px solid #444; margin-right: 10px;
        }
        input[type=range] { accent-color: #e67e22; cursor: pointer; }
        #intensityValue { font-size: 0.8rem; color: #e67e22; font-weight: bold; width: 30px; text-align: center;}

        /* Panorama add images */
        .panorama-btn-container { margin-top: 10px; display: none; }
        .add-panorama-btn {
            width: 100%;
            background: rgba(46, 204, 113, 0.15);
            border: 1px solid #2ecc71;
            color: #2ecc71;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.3s;
        }
        .add-panorama-btn:hover { background: #2ecc71; color: white; }
    </style>
</head>

<body>

<a href="index.html" class="home-btn"><i class="fas fa-home"></i> ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</a>

<div class="glass-panel">
    <div class="header-bar">
        <div class="app-logo"><img src="static/images/logo.png" alt="Alaraby TV"></div>
        <div class="version-badge">Unified Version</div>
    </div>

    <div class="inputs-row">
        <div class="input-group">
            <span class="input-label">1. SOURCE IMAGE</span>
            <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleUpload()">
            <div class="dark-input" onclick="document.getElementById('fileInput').click()">
                <span id="fileNameDisplay">üìÇ CLICK TO UPLOAD IMAGE</span>
            </div>
        </div>

        <div class="input-group">
            <span class="input-label">2. SELECT TEMPLATE</span>
            <div class="dark-input">
                <select id="templateSelect" onchange="changeTemplate()">
                    <option value="" selected style="color: #aaa;">-- Select Format --</option>
                    <option value="headline">TW-slide-headline</option>
                    <option value="avatar">TW-Avatar</option>
                    <option value="sting">TW-TopicalSting</option>
                    <option value="panorama">TW-Panorama</option>
                    <option value="webscroll">TW-WebScroll</option>
                </select>
                <i class="fas fa-chevron-down" style="margin-left: 10px; color: #888;"></i>
            </div>

            <div class="panorama-btn-container" id="panoramaControls">
                <input type="file" id="panoramaInput" accept="image/*" multiple style="display: none;" onchange="addPanoramaImages()">
                <button class="add-panorama-btn" onclick="document.getElementById('panoramaInput').click()" type="button">
                    <i class="fas fa-plus-circle"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿµŸàÿ± ÿ£ÿÆÿ±Ÿâ ŸÑŸÑÿ®ÿßŸÜŸàÿ±ÿßŸÖÿß
                </button>
            </div>
        </div>
    </div>

    <div id="placeholder-area" class="welcome-msg">ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ŸàÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÇÿßŸÑÿ® ŸÑŸÑÿ®ÿØÿ°</div>

    <div class="editor-container" id="editor-area">
        <img id="work-image" src="" style="display: block; max-width: 100%;">
    </div>

    <div class="footer-row">
        <div class="blur-controls" id="blurControls" style="display: none;">
            <div class="intensity-slider-group" title="ÿ¥ÿØÿ© ÿßŸÑÿ™ŸÖŸàŸäŸá">
                <i class="fas fa-sliders-h"></i>
                <input type="range" id="blurIntensity" min="10" max="150" value="50" oninput="updateBlurIntensity(this.value)">
                <span id="intensityValue">50</span>
            </div>
            <button class="blur-btn" onclick="resizeBlur(10)" title="ÿ™ŸÉÿ®Ÿäÿ±"><i class="fas fa-plus"></i></button>
            <button class="blur-btn" onclick="resizeBlur(-10)" title="ÿ™ÿµÿ∫Ÿäÿ±"><i class="fas fa-minus"></i></button>
            <button class="blur-btn" id="toggleBlurBtn" onclick="toggleBlur()" type="button">
                <i class="fas fa-eye-slash" id="blurToggleIcon"></i> ÿ™ŸÖŸàŸäŸá
            </button>
        </div>

        <div class="filename-container">
            <span class="input-label">3. FILE NAME (REQUIRED):</span>
            <input
                type="text"
                id="customFileName"
                class="dark-input"
                placeholder="Type new file name here..."
                style="background: #0a0a0a; cursor: text;"
                oninput="updateDownloadState()"
            >
        </div>

        <div class="buttons-container">
            <button id="downloadBtn" class="action-btn download-btn" onclick="processAndDownload()" disabled type="button">
                Download Image <i class="fas fa-arrow-down"></i>
            </button>
            <button class="action-btn reset-btn" onclick="resetTool()" type="button">
                New Image <i class="fas fa-redo"></i>
            </button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    let cropper;
    let currentImagePath = "";
    let originalFileName = "";
    let isBlurActive = false;

    // panorama
    let panoramaFiles = [];
    let stitchedObjectUrl = null;

    // ‚úÖ ÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑŸÖÿ≥ÿßÿ±: ÿ•ÿ≤ÿßŸÑÿ© / ŸÖŸÜ ÿ£ÿ≥ŸÖÿßÿ° ŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ™Ÿàÿ¨ŸäŸá
    const templates = {
        'headline': { w: 1234, h: 1080, guide: 'static/images/TW-Slide-Headline_guide.png' },
        'avatar':   { w: 400,  h: 400,  guide: 'static/images/TW-Avatar_guide.png' },
        'sting':    { w: 1920, h: 1080, guide: null },
        'panorama': { w: 3562, h: 1075, guide: 'static/images/TW-Panorama_guide.png' }
    };

    // ‚úÖ ÿ≤ÿ± ÿßŸÑÿØÿßŸàŸÜŸÑŸàŸàÿØ ŸÑÿß Ÿäÿ™ŸÅÿπŸÑ ÿ•ŸÑÿß ÿ•ÿ∞ÿß: ÿµŸàÿ±ÿ© + ŸÇÿßŸÑÿ® + ÿßÿ≥ŸÖ
    function updateDownloadState() {
        const btn = document.getElementById('downloadBtn');
        const hasImage = !!cropper;
        const hasTemplate = !!document.getElementById('templateSelect').value;
        const nameInput = document.getElementById('customFileName').value.trim();
        const hasName = nameInput.length > 0;

        btn.disabled = !(hasImage && hasTemplate && hasName);
    }

    function handleUpload() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) return;

        panoramaFiles = [file];

        originalFileName = file.name.replace(/\.[^/.]+$/, "");
        let displayName = file.name;
        if (displayName.length > 25) {
            const ext = displayName.split('.').pop();
            const name = displayName.substring(0, 15);
            displayName = name + "...." + ext;
        }
        document.getElementById('fileNameDisplay').innerText = displayName;

        // ‚úÖ ÿ™ÿπÿØŸäŸÑ: ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ URL.createObjectURL ŸÖÿ®ÿßÿ¥ÿ±ÿ©
        const imgUrl = URL.createObjectURL(file);
        
        const imgElement = document.getElementById('work-image');
        document.getElementById('placeholder-area').style.display = 'none';
        document.getElementById('editor-area').style.display = 'block';
        imgElement.src = imgUrl;

        if (cropper) cropper.destroy();

        imgElement.onload = () => {
            const selectedType = document.getElementById('templateSelect').value;
            const settings = templates[selectedType];
            const initialAspectRatio = settings ? (settings.w / settings.h) : NaN;

            cropper = new Cropper(imgElement, {
                aspectRatio: initialAspectRatio,
                viewMode: 1,
                dragMode: 'none',
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false,
                autoCrop: false,
                background: false,
                guides: false,
                center: false,
                ready() {
                    document.getElementById('blurControls').style.display = 'flex';
                    document.getElementById('blurToggleIcon').className = 'fas fa-eye-slash';
                    const oldBlur = document.getElementById('blur-circle');
                    if(oldBlur) oldBlur.remove();
                    checkPanoramaMode();
                    setTimeout(() => applyCurrentTemplate(), 100);
                    updateDownloadState();
                }
            });
        };
    }

    function changeTemplate() {
        const type = document.getElementById('templateSelect').value;

        // ‚úÖ ÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑŸÖÿ≥ÿßÿ±: ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÑŸÑÿ£ÿØÿßÿ© ÿßŸÑŸÇÿØŸäŸÖÿ©
        if (type === 'webscroll') {
            window.location.href = 'cleaner.html';
            return;
        }

        checkPanoramaMode();

        if (cropper && type) {
            applyCurrentTemplate();
        }
        updateDownloadState();
    }

    function applyCurrentTemplate() {
        const type = document.getElementById('templateSelect').value;
        if (!type || !templates[type] || !cropper) return;

        const settings = templates[type];
        cropper.crop();
        cropper.setAspectRatio(settings.w / settings.h);
        updateOverlay(settings.guide);
    }

    function checkPanoramaMode() {
        const type = document.getElementById('templateSelect').value;
        const panoControls = document.getElementById('panoramaControls');
        panoControls.style.display = (type === 'panorama') ? 'block' : 'none';
    }

    function addPanoramaImages() {
        const input = document.getElementById('panoramaInput');
        if (input.files && input.files.length > 0) {
            for (let i = 0; i < input.files.length; i++) {
                panoramaFiles.push(input.files[i]);
            }
            stitchImagesAndReload();
        }
    }

    function stitchImagesAndReload() {
        if (panoramaFiles.length < 2) return;

        const loadedImages = [];
        let loadedCount = 0;
        const tempUrls = [];

        panoramaFiles.forEach((file) => {
            const img = new Image();
            const url = URL.createObjectURL(file);
            tempUrls.push(url);

            img.onload = () => {
                loadedCount++;
                if (loadedCount === panoramaFiles.length) {
                    tempUrls.forEach(u => URL.revokeObjectURL(u));
                    createStitchedCanvas(loadedImages);
                }
            };
            img.onerror = () => {
                tempUrls.forEach(u => URL.revokeObjectURL(u));
                alert("ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿØŸâ ÿµŸàÿ± ÿßŸÑÿ®ÿßŸÜŸàÿ±ÿßŸÖÿß.");
            };
            img.src = url;
            loadedImages.push(img);
        });
    }

    function createStitchedCanvas(images) {
        const MAX_CANVAS_WIDTH = 3800;
        const BASE_HEIGHT = 1080;
        const separatorWidth = 20;

        let totalWidthTheoretical = 0;
        images.forEach((img, index) => {
            const scale = BASE_HEIGHT / img.height;
            totalWidthTheoretical += (img.width * scale);
            if (index < images.length - 1) totalWidthTheoretical += separatorWidth;
        });

        let reductionRatio = 1;
        if (totalWidthTheoretical > MAX_CANVAS_WIDTH) {
            reductionRatio = MAX_CANVAS_WIDTH / totalWidthTheoretical;
        }

        const finalWidth  = Math.max(1, Math.round(totalWidthTheoretical * reductionRatio));
        const finalHeight = Math.max(1, Math.round(BASE_HEIGHT * reductionRatio));

        const canvas = document.createElement('canvas');
        canvas.width = finalWidth;
        canvas.height = finalHeight;
        const ctx = canvas.getContext('2d', { alpha: false });

        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        let currentX = 0;
        images.forEach((img, index) => {
            const baseScale = BASE_HEIGHT / img.height;
            const drawWidth = Math.round((img.width * baseScale) * reductionRatio);
            const drawHeight = finalHeight;
            ctx.drawImage(img, currentX, 0, drawWidth, drawHeight);
            currentX += drawWidth;
            if (index < images.length - 1) currentX += Math.round(separatorWidth * reductionRatio);
        });

        if (stitchedObjectUrl) URL.revokeObjectURL(stitchedObjectUrl);

        canvas.toBlob((blob) => {
            if (!blob) {
                alert("ŸÅÿ¥ŸÑ ÿØŸÖÿ¨ ÿßŸÑÿµŸàÿ±.");
                return;
            }
            stitchedObjectUrl = URL.createObjectURL(blob);
            const imgElement = document.getElementById('work-image');
            imgElement.src = stitchedObjectUrl;

            if (cropper) cropper.destroy();

            imgElement.onload = () => {
                const selectedType = document.getElementById('templateSelect').value;
                const settings = templates[selectedType];
                const initialAspectRatio = settings ? (settings.w / settings.h) : NaN;

                cropper = new Cropper(imgElement, {
                    aspectRatio: initialAspectRatio,
                    viewMode: 1,
                    dragMode: 'none',
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    background: false,
                    guides: false,
                    center: false,
                    ready() {
                        setTimeout(() => applyCurrentTemplate(), 150);
                        updateDownloadState();
                    }
                });
            };
        }, 'image/jpeg', 0.85);
    }

    function updateOverlay(guideImageName) {
        const oldOverlays = document.querySelectorAll('.overlay-ghost');
        oldOverlays.forEach(img => img.remove());
        if (!guideImageName) return;
        const cropBox = document.querySelector('.cropper-face');
        if (!cropBox) return;

        const img = document.createElement('img');
        // ‚úÖ ÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑŸÖÿ≥ÿßÿ±
        img.src = `${guideImageName}`;
        img.className = 'overlay-ghost';
        cropBox.appendChild(img);
    }

    function toggleBlur() {
        const container = document.getElementById('editor-area');
        if (!container) return;
        let blurCircle = document.getElementById('blur-circle');
        const btn = document.getElementById('toggleBlurBtn');
        const icon = document.getElementById('blurToggleIcon');

        if (isBlurActive) {
            if(blurCircle) blurCircle.style.display = 'none';
            isBlurActive = false;
            btn.classList.remove('active');
            icon.className = 'fas fa-eye-slash';
        } else {
            if (!blurCircle) {
                blurCircle = document.createElement('div');
                blurCircle.id = 'blur-circle';
                container.appendChild(blurCircle);
                initDrag(blurCircle);
                const val = document.getElementById('blurIntensity').value;
                updateBlurIntensity(val);
            }
            blurCircle.style.display = 'block';
            isBlurActive = true;
            btn.classList.add('active');
            icon.className = 'fas fa-eye';
        }
    }

    function updateBlurIntensity(val) {
        document.getElementById('intensityValue').innerText = val;
        const blurCircle = document.getElementById('blur-circle');
        if (blurCircle) {
            const cssBlur = val / 10;
            blurCircle.style.backdropFilter = `blur(${cssBlur}px)`;
            blurCircle.style.webkitBackdropFilter = `blur(${cssBlur}px)`;
        }
    }

    function resizeBlur(delta) {
        const blurCircle = document.getElementById('blur-circle');
        if (!blurCircle || !isBlurActive) return;
        let currentSize = parseInt(window.getComputedStyle(blurCircle).width);
        let newSize = currentSize + delta;
        if (newSize < 20) newSize = 20;
        blurCircle.style.width = newSize + 'px';
        blurCircle.style.height = newSize + 'px';
    }

    function initDrag(el) {
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;
        el.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            initialLeft = el.offsetLeft;
            initialTop = el.offsetTop;
            e.stopPropagation(); e.preventDefault();
        });
        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            el.style.left = (initialLeft + dx) + 'px';
            el.style.top = (initialTop + dy) + 'px';
            el.style.transform = 'none';
        });
        window.addEventListener('mouseup', () => { isDragging = false; });
    }

    function processAndDownload() {
        if (!cropper) return;
        const type = document.getElementById('templateSelect').value;
        const settings = templates[type];
        if (!type || !settings) { alert("ÿßÿÆÿ™Ÿéÿ± ÿßŸÑŸÇÿßŸÑÿ® ÿ£ŸàŸÑÿßŸã ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ."); return; }

        const nameInput = document.getElementById('customFileName').value.trim();
        if (!nameInput) { alert("ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ ÿ£ŸàŸÑÿßŸã."); updateDownloadState(); return; }

        const btn = document.getElementById('downloadBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Processing... <i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        setTimeout(() => {
            try {
                let finalName = nameInput.replace(/\.(png|jpg|jpeg)$/i, '') + ".jpg";
                const finalCanvas = cropper.getCroppedCanvas({
                    width: settings.w,
                    height: settings.h,
                    fillColor: '#fff',
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'medium'
                });

                if (!finalCanvas) throw new Error("Canvas generation failed");

                finalCanvas.toBlob((blob) => {
                    if (!blob) {
                        alert("ŸÅÿ¥ŸÑ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°.");
                        btn.innerHTML = originalText;
                        updateDownloadState();
                        return;
                    }
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = finalName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    btn.innerHTML = originalText;
                    updateDownloadState();
                }, 'image/jpeg', 0.90);
            } catch (e) {
                console.error(e);
                alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©.");
                btn.innerHTML = originalText;
                updateDownloadState();
            }
        }, 50);
    }

    function resetTool() {
        const fileInput = document.getElementById('fileInput');
        fileInput.value = '';
        document.getElementById('fileNameDisplay').innerText = 'üìÇ CLICK TO UPLOAD IMAGE';
        originalFileName = "";
        panoramaFiles = [];
        if (stitchedObjectUrl) { URL.revokeObjectURL(stitchedObjectUrl); stitchedObjectUrl = null; }
        document.getElementById('panoramaInput').value = '';
        document.getElementById('panoramaControls').style.display = 'none';
        isBlurActive = false;
        document.getElementById('toggleBlurBtn').classList.remove('active');
        document.getElementById('blurToggleIcon').className = 'fas fa-eye-slash';
        const blurCircle = document.getElementById('blur-circle');
        if(blurCircle) blurCircle.remove();
        document.getElementById('blurControls').style.display = 'none';
        document.getElementById('blurIntensity').value = 50;
        document.getElementById('intensityValue').innerText = "50";
        document.getElementById('editor-area').style.display = 'none';
        document.getElementById('placeholder-area').style.display = 'block';
        document.getElementById('templateSelect').selectedIndex = 0;
        document.getElementById('customFileName').value = '';
        if (cropper) { cropper.destroy(); cropper = null; }
        document.getElementById('work-image').src = "";
        const oldOverlays = document.querySelectorAll('.overlay-ghost');
        oldOverlays.forEach(img => img.remove());
        updateDownloadState();
    }

    window.addEventListener('DOMContentLoaded', () => {
        updateDownloadState();
    });
</script>

</body>
</html>


