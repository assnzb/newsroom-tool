<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÿ∫ÿ±ŸÅÿ© ÿßŸÑÿ≥Ÿàÿ¥ŸäÿßŸÑ ŸÖŸäÿØŸäÿß | Social Hub</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet"/>

  <style>
    * { box-sizing: border-box; }

    body{
      font-family:'Tajawal',sans-serif;
      margin:0; padding:0;
      height:100vh;
      display:flex; align-items:center; justify-content:center;
      background:
        linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.7)),
        url("static/images/social_background.jpg") no-repeat center center fixed;
      background-size:cover;
    }

    .home-btn{
      position:absolute; top:30px; left:30px;
      text-decoration:none; color:#fff;
      background:rgba(255,255,255,0.1);
      padding:10px 20px; border-radius:30px;
      display:flex; align-items:center; gap:10px;
      font-weight:bold;
      border:1px solid rgba(255,255,255,0.2);
      transition:.3s; z-index:2000;
      backdrop-filter: blur(5px);
    }
    .home-btn:hover{
      background:rgba(255,255,255,0.2);
      transform:scale(1.05);
      border-color:#2ecc71;
    }

    .glass-panel{
      background:rgba(20,20,20,0.95);
      border:1px solid #333;
      border-radius:12px;
      width:90%;
      max-width:1100px;
      padding:40px;
      box-shadow:0 20px 50px rgba(0,0,0,0.8);
      position:relative;
    }

    .header-bar{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:30px; position:relative; z-index:60;
    }
    .app-logo img{ height:55px; }
    .version-badge{
      background:#333; color:#888;
      padding:6px 15px; border-radius:15px;
      font-size:.9rem; border:1px solid #444;
    }

    .inputs-row{
      display:flex; gap:30px; margin-bottom:25px;
      direction:ltr !important;
      position:relative; z-index:50; width:100%;
    }
    .input-group{ flex:1; text-align:left; position:relative; }
    .input-label{
      display:block; color:#ccc; font-size:.95rem;
      font-weight:800; text-transform:uppercase;
      margin-bottom:10px; letter-spacing:.5px;
    }

    .dark-input{
      width:100%;
      background:#111;
      border:1px solid #444;
      color:#fff;
      padding:15px 20px;
      border-radius:8px;
      font-family:'Tajawal',sans-serif;
      font-size:1rem; font-weight:bold;
      outline:none;
      transition:.3s;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
      direction:ltr;
    }
    .dark-input:hover{ border-color:#2ecc71; background:#1a1a1a; }
    .dark-input select{
      background:transparent; border:none; color:#fff; width:100%;
      font-family:'Tajawal'; font-size:1rem; font-weight:bold;
      cursor:pointer; outline:none; appearance:none;
    }
    .dark-input select option{ background-color:#1a1a1a; color:#fff; padding:15px; }
    #fileNameDisplay{
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:100%; direction:ltr; text-align:left;
    }

    .editor-container{
      width:100%;
      height:500px;
      background:#050505;
      border:2px dashed #333;
      border-radius:10px;
      display:none;
      overflow:hidden;
      position:relative;
      margin-bottom:25px;
      z-index:1;
    }

    .welcome-msg{
      text-align:center;
      color:#555;
      padding:70px;
      border:2px dashed #333;
      border-radius:10px;
      font-size:1.2rem;
    }

    .cropper-face{ background-color:transparent !important; opacity:1 !important; }
    .overlay-ghost{
      position:absolute; top:0; left:0; width:100%; height:100%;
      z-index:50;
      pointer-events:none !important;
      opacity:.85 !important;
      display:block;
    }
    .cropper-view-box{ outline:2px solid #2ecc71; }
    .cropper-modal{ opacity:.6; background-color:#000; }
    .cropper-dashed, .cropper-line{ display:none !important; }
    .cropper-point{ width:10px; height:10px; background-color:#2ecc71; opacity:.9; }

    /* Blur Circle inside cropper-container */
    #blur-circle{
      position:absolute;
      width:140px; height:140px;
      border-radius:50%;
      border:2px dashed rgba(255,255,255,0.75);
      background:rgba(255,255,255,0.08);
      box-shadow:0 0 18px rgba(0,0,0,0.6);
      z-index:999999;
      display:none;
      cursor:grab;
      user-select:none;
      touch-action:none;
      pointer-events:auto;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      transform:none;
    }
    #blur-circle:active{ cursor:grabbing; border-color:#e67e22; }
    #blur-circle::after{
      content:"BLUR";
      position:absolute;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      color:rgba(255,255,255,0.75);
      font-size:12px;
      font-weight:900;
      letter-spacing:1px;
      pointer-events:none;
    }

    .footer-row{ margin-top:10px; position:relative; z-index:50; }
    .filename-container{
      direction:ltr !important;
      text-align:left !important;
      margin-bottom:15px;
      width:100%;
    }
    .filename-container .input-label{ text-align:left; }
    .filename-container .dark-input{ direction:ltr; text-align:left; width:100%; }

    .buttons-container{ display:flex; gap:15px; margin-top:15px; direction:ltr; }

    .action-btn{
      background:#e0e0e0;
      color:#000;
      font-weight:900;
      padding:16px;
      border:none;
      border-radius:8px;
      font-size:1.1rem;
      cursor:pointer;
      transition:.3s;
      text-transform:uppercase;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .action-btn:hover{ background:#fff; transform:translateY(-2px); }
    .action-btn:disabled{ background:#333; color:#555; cursor:not-allowed; transform:none; }

    .reset-btn{ background:#c0392b; color:#fff; flex:1; }
    .reset-btn:hover{ background:#e74c3c; }
    .download-btn{ flex:3; }

    .blur-controls{
      display:flex; gap:10px; margin-bottom:15px;
      justify-content:flex-end;
      direction:ltr; align-items:center;
    }
    .blur-btn{
      background:#333; color:#ccc; border:1px solid #555;
      padding:8px 15px;
      border-radius:5px;
      cursor:pointer;
      font-weight:bold;
      font-size:.9rem;
      transition:.2s;
      display:flex; align-items:center; gap:8px;
    }
    .blur-btn:hover{ background:#444; color:#fff; }
    .blur-btn.active{ background:#e67e22; color:#fff; border-color:#e67e22; }

    .intensity-slider-group{
      display:flex; align-items:center; gap:10px; color:#ccc;
      background:#222; padding:5px 15px;
      border-radius:20px;
      border:1px solid #444;
      margin-right:10px;
    }
    input[type=range]{ accent-color:#e67e22; cursor:pointer; }
    #intensityValue{ font-size:.8rem; color:#e67e22; font-weight:bold; width:30px; text-align:center; }

    /* Panorama add images */
    .panorama-btn-container{ margin-top:10px; display:none; }
    .add-panorama-btn{
      width:100%;
      background:rgba(46,204,113,0.15);
      border:1px solid #2ecc71;
      color:#2ecc71;
      padding:10px;
      border-radius:8px;
      cursor:pointer;
      font-weight:bold;
      display:flex; align-items:center; justify-content:center; gap:8px;
      transition:.3s;
    }
    .add-panorama-btn:hover{ background:#2ecc71; color:#fff; }
  </style>
</head>

<body>
  <a href="index.html" class="home-btn"><i class="fas fa-home"></i> ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</a>

  <div class="glass-panel">
    <div class="header-bar">
      <div class="app-logo"><img src="static/images/logo.png" alt="Alaraby TV"/></div>
      <div class="version-badge">Unified Version</div>
    </div>

    <div class="inputs-row">
      <div class="input-group">
        <span class="input-label">1. SOURCE IMAGE</span>
        <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleUpload()"/>
        <div class="dark-input" onclick="document.getElementById('fileInput').click()">
          <span id="fileNameDisplay">üìÇ CLICK TO UPLOAD IMAGE</span>
        </div>
      </div>

      <div class="input-group">
        <span class="input-label">2. SELECT TEMPLATE</span>
        <div class="dark-input">
          <select id="templateSelect" onchange="changeTemplate()">
            <option value="" selected style="color:#aaa;">-- Select Format --</option>
            <option value="headline">TW-slide-headline</option>
            <option value="avatar">TW-Avatar</option>
            <option value="sting">TW-TopicalSting</option>
            <option value="panorama">TW-Panorama</option>
            <option value="webscroll">TW-WebScroll</option>
          </select>
          <i class="fas fa-chevron-down" style="margin-left:10px; color:#888;"></i>
        </div>

        <div class="panorama-btn-container" id="panoramaControls">
          <input type="file" id="panoramaInput" accept="image/*" multiple style="display:none;" onchange="addPanoramaImages()"/>
          <button class="add-panorama-btn" onclick="document.getElementById('panoramaInput').click()" type="button">
            <i class="fas fa-plus-circle"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿµŸàÿ± ÿ£ÿÆÿ±Ÿâ ŸÑŸÑÿ®ÿßŸÜŸàÿ±ÿßŸÖÿß
          </button>
        </div>
      </div>
    </div>

    <div id="placeholder-area" class="welcome-msg">ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ŸàÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÇÿßŸÑÿ® ŸÑŸÑÿ®ÿØÿ°</div>

    <div class="editor-container" id="editor-area">
      <img id="work-image" src="" style="display:block; max-width:100%;"/>
    </div>

    <div class="footer-row">
      <div class="blur-controls" id="blurControls" style="display:none;">
        <div class="intensity-slider-group" title="ÿ¥ÿØÿ© ÿßŸÑÿ™ŸÖŸàŸäŸá">
          <i class="fas fa-sliders-h"></i>
          <input type="range" id="blurIntensity" min="10" max="150" value="50" oninput="updateBlurIntensity(this.value)"/>
          <span id="intensityValue">50</span>
        </div>
        <button class="blur-btn" onclick="resizeBlur(10)" title="ÿ™ŸÉÿ®Ÿäÿ±" type="button"><i class="fas fa-plus"></i></button>
        <button class="blur-btn" onclick="resizeBlur(-10)" title="ÿ™ÿµÿ∫Ÿäÿ±" type="button"><i class="fas fa-minus"></i></button>
        <button class="blur-btn" id="toggleBlurBtn" onclick="toggleBlur()" type="button">
          <i class="fas fa-eye-slash" id="blurToggleIcon"></i> ÿ™ŸÖŸàŸäŸá
        </button>
      </div>

      <div class="filename-container">
        <span class="input-label">3. FILE NAME (REQUIRED):</span>
        <input
          type="text"
          id="customFileName"
          class="dark-input"
          placeholder="Type new file name here..."
          style="background:#0a0a0a; cursor:text;"
          oninput="updateDownloadState()"
        />
      </div>

      <div class="buttons-container">
        <button id="downloadBtn" class="action-btn download-btn" onclick="processAndDownload()" disabled type="button">
          Download Image <i class="fas fa-arrow-down"></i>
        </button>
        <button class="action-btn reset-btn" onclick="resetTool()" type="button">
          New Image <i class="fas fa-redo"></i>
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script>
    let cropper = null;
    let isBlurActive = false;

    // panorama
    let panoramaFiles = [];
    let stitchedObjectUrl = null;

    // blur drag
    let blurDrag = { active:false, startX:0, startY:0, startLeft:0, startTop:0 };

    // ‚úÖ Feather
    const FEATHER_RATIO = 0.18;

    const templates = {
      headline: { w:1234, h:1080, guide:"static/images/TW-Slide-Headline_guide.png" },
      avatar:   { w:400,  h:400,  guide:"static/images/TW-Avatar_guide.png" },
      sting:    { w:1920, h:1080, guide:null },
      panorama: { w:3562, h:1075, guide:"static/images/TW-Panorama_guide.png" }
    };

    function updateDownloadState(){
      const btn = document.getElementById("downloadBtn");
      const hasImage = !!cropper;
      const hasTemplate = !!document.getElementById("templateSelect").value;
      const hasName = document.getElementById("customFileName").value.trim().length > 0;
      btn.disabled = !(hasImage && hasTemplate && hasName);
    }

    function handleUpload(){
      const input = document.getElementById("fileInput");
      const file = input.files[0];
      if(!file) return;

      panoramaFiles = [file];

      let displayName = file.name;
      if(displayName.length > 25){
        const ext = displayName.split(".").pop();
        const name = displayName.substring(0, 15);
        displayName = name + "...." + ext;
      }
      document.getElementById("fileNameDisplay").innerText = displayName;

      const imgUrl = URL.createObjectURL(file);
      const img = document.getElementById("work-image");

      document.getElementById("placeholder-area").style.display = "none";
      document.getElementById("editor-area").style.display = "block";

      img.src = imgUrl;

      if(cropper) cropper.destroy();

      img.onload = () => {
        const selectedType = document.getElementById("templateSelect").value;
        const settings = templates[selectedType];
        const initialAspectRatio = settings ? (settings.w / settings.h) : NaN;

        cropper = new Cropper(img, {
          aspectRatio: initialAspectRatio,
          viewMode: 1,
          dragMode: "none",
          cropBoxMovable: true,
          cropBoxResizable: true,
          toggleDragModeOnDblclick: false,
          autoCrop: false,
          background: false,
          guides: false,
          center: false,
          ready(){
            document.getElementById("blurControls").style.display = "flex";

            removeBlurCircle();
            isBlurActive = false;
            setBlurBtnUI(false);

            checkPanoramaMode();
            setTimeout(() => applyCurrentTemplate(), 100);
            updateDownloadState();
          }
        });
      };
    }

    function changeTemplate(){
      const type = document.getElementById("templateSelect").value;

      if(type === "webscroll"){
        window.location.href = "cleaner.html";
        return;
      }

      checkPanoramaMode();
      if(cropper && type) applyCurrentTemplate();
      updateDownloadState();
    }

    function applyCurrentTemplate(){
      const type = document.getElementById("templateSelect").value;
      if(!type || !templates[type] || !cropper) return;

      const settings = templates[type];
      cropper.crop();
      cropper.setAspectRatio(settings.w / settings.h);
      updateOverlay(settings.guide);
    }

    function checkPanoramaMode(){
      const type = document.getElementById("templateSelect").value;
      document.getElementById("panoramaControls").style.display = (type === "panorama") ? "block" : "none";
    }

    function addPanoramaImages(){
      const input = document.getElementById("panoramaInput");
      if(input.files && input.files.length > 0){
        for(let i=0;i<input.files.length;i++) panoramaFiles.push(input.files[i]);
        stitchImagesAndReload();
      }
    }

    function stitchImagesAndReload(){
      if(panoramaFiles.length < 2) return;

      const loadedImages = [];
      let loadedCount = 0;
      const tempUrls = [];

      panoramaFiles.forEach((file) => {
        const im = new Image();
        const url = URL.createObjectURL(file);
        tempUrls.push(url);

        im.onload = () => {
          loadedCount++;
          if(loadedCount === panoramaFiles.length){
            tempUrls.forEach(u => URL.revokeObjectURL(u));
            createStitchedCanvas(loadedImages);
          }
        };

        im.onerror = () => {
          tempUrls.forEach(u => URL.revokeObjectURL(u));
          alert("ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿØŸâ ÿµŸàÿ± ÿßŸÑÿ®ÿßŸÜŸàÿ±ÿßŸÖÿß.");
        };

        im.src = url;
        loadedImages.push(im);
      });
    }

    function createStitchedCanvas(images){
      const MAX_CANVAS_WIDTH = 3800;
      const BASE_HEIGHT = 1080;
      const separatorWidth = 20;

      let totalWidthTheoretical = 0;
      images.forEach((img, idx) => {
        const scale = BASE_HEIGHT / img.height;
        totalWidthTheoretical += (img.width * scale);
        if(idx < images.length - 1) totalWidthTheoretical += separatorWidth;
      });

      let reductionRatio = 1;
      if(totalWidthTheoretical > MAX_CANVAS_WIDTH){
        reductionRatio = MAX_CANVAS_WIDTH / totalWidthTheoretical;
      }

      const finalWidth  = Math.max(1, Math.round(totalWidthTheoretical * reductionRatio));
      const finalHeight = Math.max(1, Math.round(BASE_HEIGHT * reductionRatio));

      const canvas = document.createElement("canvas");
      canvas.width = finalWidth;
      canvas.height = finalHeight;
      const ctx = canvas.getContext("2d", { alpha:false });

      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      let currentX = 0;
      images.forEach((img, idx) => {
        const baseScale = BASE_HEIGHT / img.height;
        const drawWidth = Math.round((img.width * baseScale) * reductionRatio);
        const drawHeight = finalHeight;

        ctx.drawImage(img, currentX, 0, drawWidth, drawHeight);
        currentX += drawWidth;
        if(idx < images.length - 1) currentX += Math.round(separatorWidth * reductionRatio);
      });

      if(stitchedObjectUrl) URL.revokeObjectURL(stitchedObjectUrl);

      canvas.toBlob((blob) => {
        if(!blob){
          alert("ŸÅÿ¥ŸÑ ÿØŸÖÿ¨ ÿßŸÑÿµŸàÿ±.");
          return;
        }

        stitchedObjectUrl = URL.createObjectURL(blob);

        const imgEl = document.getElementById("work-image");
        imgEl.src = stitchedObjectUrl;

        if(cropper) cropper.destroy();

        imgEl.onload = () => {
          const selectedType = document.getElementById("templateSelect").value;
          const settings = templates[selectedType];
          const initialAspectRatio = settings ? (settings.w / settings.h) : NaN;

          cropper = new Cropper(imgEl, {
            aspectRatio: initialAspectRatio,
            viewMode: 1,
            dragMode: "none",
            cropBoxMovable: true,
            cropBoxResizable: true,
            background: false,
            guides: false,
            center: false,
            ready(){
              removeBlurCircle();
              isBlurActive = false;
              setBlurBtnUI(false);

              setTimeout(() => applyCurrentTemplate(), 150);
              updateDownloadState();
            }
          });
        };
      }, "image/jpeg", 0.85);
    }

    function updateOverlay(guidePath){
      document.querySelectorAll(".overlay-ghost").forEach(el => el.remove());
      if(!guidePath) return;

      const cropBox = document.querySelector(".cropper-face");
      if(!cropBox) return;

      const img = document.createElement("img");
      img.src = guidePath;     // ‚úÖ GitHub relative path
      img.className = "overlay-ghost";
      cropBox.appendChild(img);
    }

    // =========================
    // BLUR + FEATHER (REAL EXPORT)
    // =========================

    function setBlurBtnUI(active){
      const btn = document.getElementById("toggleBlurBtn");
      const icon = document.getElementById("blurToggleIcon");
      if(active){
        btn.classList.add("active");
        icon.className = "fas fa-eye";
      }else{
        btn.classList.remove("active");
        icon.className = "fas fa-eye-slash";
      }
    }

    function getCropperContainer(){
      return document.querySelector(".cropper-container");
    }

    function ensureBlurCircle(){
      const container = getCropperContainer();
      if(!container) return null;

      let circle = document.getElementById("blur-circle");
      if(circle) return circle;

      circle = document.createElement("div");
      circle.id = "blur-circle";
      container.appendChild(circle);

      // center
      const rect = container.getBoundingClientRect();
      const size = 140;
      circle.style.left = Math.max(0, (rect.width - size) / 2) + "px";
      circle.style.top  = Math.max(0, (rect.height - size) / 2) + "px";

      circle.addEventListener("pointerdown", onBlurPointerDown, { passive:false });
      return circle;
    }

    function removeBlurCircle(){
      const c = document.getElementById("blur-circle");
      if(c) c.remove();
    }

    function onBlurPointerDown(e){
      if(!isBlurActive) return;

      const circle = e.currentTarget;
      const container = getCropperContainer();
      if(!container) return;

      e.preventDefault();
      e.stopPropagation();

      circle.setPointerCapture(e.pointerId);

      const circleRect = circle.getBoundingClientRect();
      const contRect = container.getBoundingClientRect();

      blurDrag.active = true;
      blurDrag.startX = e.clientX;
      blurDrag.startY = e.clientY;
      blurDrag.startLeft = circleRect.left - contRect.left;
      blurDrag.startTop  = circleRect.top  - contRect.top;

      window.addEventListener("pointermove", onBlurPointerMove, { passive:false });
      window.addEventListener("pointerup", onBlurPointerUp, { passive:false });
    }

    function onBlurPointerMove(e){
      if(!blurDrag.active) return;
      e.preventDefault();

      const container = getCropperContainer();
      const circle = document.getElementById("blur-circle");
      if(!container || !circle) return;

      const contRect = container.getBoundingClientRect();
      const size = parseInt(getComputedStyle(circle).width, 10);

      const dx = e.clientX - blurDrag.startX;
      const dy = e.clientY - blurDrag.startY;

      let newLeft = blurDrag.startLeft + dx;
      let newTop  = blurDrag.startTop  + dy;

      newLeft = Math.max(0, Math.min(newLeft, contRect.width - size));
      newTop  = Math.max(0, Math.min(newTop,  contRect.height - size));

      circle.style.left = newLeft + "px";
      circle.style.top  = newTop  + "px";
    }

    function onBlurPointerUp(){
      blurDrag.active = false;
      window.removeEventListener("pointermove", onBlurPointerMove);
      window.removeEventListener("pointerup", onBlurPointerUp);
    }

    function toggleBlur(){
      if(!cropper) return;

      if(isBlurActive){
        isBlurActive = false;
        setBlurBtnUI(false);

        const circle = document.getElementById("blur-circle");
        if(circle) circle.style.display = "none";
        try { cropper.setDragMode("none"); } catch {}
        return;
      }

      const circle = ensureBlurCircle();
      if(!circle) return;

      isBlurActive = true;
      setBlurBtnUI(true);
      circle.style.display = "block";

      try { cropper.setDragMode("none"); } catch {}
      updateBlurIntensity(document.getElementById("blurIntensity").value);
    }

    function updateBlurIntensity(val){
      document.getElementById("intensityValue").innerText = val;
      const circle = document.getElementById("blur-circle");
      if(!circle) return;

      const cssBlur = val / 10;
      circle.style.backdropFilter = `blur(${cssBlur}px)`;
      circle.style.webkitBackdropFilter = `blur(${cssBlur}px)`;
    }

    function resizeBlur(delta){
      const circle = document.getElementById("blur-circle");
      if(!circle || !isBlurActive) return;

      const container = getCropperContainer();
      if(!container) return;

      const contRect = container.getBoundingClientRect();
      let size = parseInt(getComputedStyle(circle).width, 10);
      size += delta;

      if(size < 30) size = 30;
      if(size > Math.min(contRect.width, contRect.height)) size = Math.min(contRect.width, contRect.height);

      const left = parseFloat(circle.style.left || "0");
      const top  = parseFloat(circle.style.top  || "0");
      const oldSize = parseInt(getComputedStyle(circle).width, 10);

      const cx = left + oldSize / 2;
      const cy = top  + oldSize / 2;

      let newLeft = cx - size / 2;
      let newTop  = cy - size / 2;

      newLeft = Math.max(0, Math.min(newLeft, contRect.width - size));
      newTop  = Math.max(0, Math.min(newTop,  contRect.height - size));

      circle.style.width = size + "px";
      circle.style.height = size + "px";
      circle.style.left = newLeft + "px";
      circle.style.top  = newTop  + "px";
    }

    function applyBlurFeatherToFinalCanvas(finalCanvas, outW, outH){
      if(!isBlurActive) return finalCanvas;

      const circle = document.getElementById("blur-circle");
      const container = getCropperContainer();
      if(!circle || !container || !cropper) return finalCanvas;

      const cropBox = cropper.getCropBoxData();
      const contRect = container.getBoundingClientRect();
      const circleRect = circle.getBoundingClientRect();

      const cx = (circleRect.left - contRect.left) + circleRect.width / 2;
      const cy = (circleRect.top  - contRect.top ) + circleRect.height / 2;
      const r  = circleRect.width / 2;

      const u = (cx - cropBox.left) / cropBox.width;
      const v = (cy - cropBox.top ) / cropBox.height;
      const rr = r / cropBox.width;

      if(u < -0.2 || v < -0.2 || u > 1.2 || v > 1.2) return finalCanvas;

      const outCx = u * outW;
      const outCy = v * outH;
      const outR  = rr * outW;

      const strength = parseInt(document.getElementById("blurIntensity").value, 10);
      const blurPx = Math.max(3, Math.round(strength / 6));

      const ctx = finalCanvas.getContext("2d");

      // base
      const base = document.createElement("canvas");
      base.width = outW; base.height = outH;
      base.getContext("2d").drawImage(finalCanvas, 0, 0);

      // blurred
      const blurred = document.createElement("canvas");
      blurred.width = outW; blurred.height = outH;
      const bctx = blurred.getContext("2d");
      bctx.filter = `blur(${blurPx}px)`;
      bctx.drawImage(base, 0, 0);
      bctx.filter = "none";

      // mask (feather)
      const mask = document.createElement("canvas");
      mask.width = outW; mask.height = outH;
      const mctx = mask.getContext("2d");

      const inner = Math.max(0, outR * (1 - FEATHER_RATIO));
      const outer = outR;

      const grad = mctx.createRadialGradient(outCx, outCy, inner, outCx, outCy, outer);
      grad.addColorStop(0, "rgba(255,255,255,1)");
      grad.addColorStop(1, "rgba(255,255,255,0)");

      mctx.fillStyle = grad;
      mctx.fillRect(0, 0, outW, outH);

      // blurMasked = blurred * mask
      const blurMasked = document.createElement("canvas");
      blurMasked.width = outW; blurMasked.height = outH;
      const bm = blurMasked.getContext("2d");
      bm.drawImage(blurred, 0, 0);
      bm.globalCompositeOperation = "destination-in";
      bm.drawImage(mask, 0, 0);
      bm.globalCompositeOperation = "source-over";

      // output = base + blurMasked
      ctx.clearRect(0, 0, outW, outH);
      ctx.drawImage(base, 0, 0);
      ctx.drawImage(blurMasked, 0, 0);

      return finalCanvas;
    }

    function processAndDownload(){
      if(!cropper) return;

      const type = document.getElementById("templateSelect").value;
      const settings = templates[type];
      if(!type || !settings){
        alert("ÿßÿÆÿ™Ÿéÿ± ÿßŸÑŸÇÿßŸÑÿ® ÿ£ŸàŸÑÿßŸã ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ.");
        return;
      }

      const nameInput = document.getElementById("customFileName").value.trim();
      if(!nameInput){
        alert("ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ ÿ£ŸàŸÑÿßŸã.");
        updateDownloadState();
        return;
      }

      const btn = document.getElementById("downloadBtn");
      const originalText = btn.innerHTML;

      btn.innerHTML = 'Processing... <i class="fas fa-spinner fa-spin"></i>';
      btn.disabled = true;

      setTimeout(() => {
        try{
          const finalName = nameInput.replace(/\.(png|jpg|jpeg)$/i, "") + ".jpg";

          let finalCanvas = cropper.getCroppedCanvas({
            width: settings.w,
            height: settings.h,
            fillColor: "#fff",
            imageSmoothingEnabled: true,
            imageSmoothingQuality: "medium"
          });

          if(!finalCanvas) throw new Error("Canvas generation failed");

          // ‚úÖ apply blur+feather to exported image
          finalCanvas = applyBlurFeatherToFinalCanvas(finalCanvas, settings.w, settings.h);

          finalCanvas.toBlob((blob) => {
            if(!blob){
              alert("ŸÅÿ¥ŸÑ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°.");
              btn.innerHTML = originalText;
              updateDownloadState();
              return;
            }
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = finalName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            btn.innerHTML = originalText;
            updateDownloadState();
          }, "image/jpeg", 0.9);

        }catch(e){
          console.error(e);
          alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£. ÿ¨ÿ±Ÿëÿ® ÿµŸàÿ± ÿ£ÿµÿ∫ÿ± ÿ£Ÿà ÿπÿØÿØ ÿ£ŸÇŸÑ.");
          btn.innerHTML = originalText;
          updateDownloadState();
        }
      }, 50);
    }

    function resetTool(){
      document.getElementById("fileInput").value = "";
      document.getElementById("fileNameDisplay").innerText = "üìÇ CLICK TO UPLOAD IMAGE";

      panoramaFiles = [];
      if(stitchedObjectUrl){
        URL.revokeObjectURL(stitchedObjectUrl);
        stitchedObjectUrl = null;
      }
      document.getElementById("panoramaInput").value = "";
      document.getElementById("panoramaControls").style.display = "none";

      removeBlurCircle();
      isBlurActive = false;
      setBlurBtnUI(false);

      document.getElementById("blurControls").style.display = "none";
      document.getElementById("blurIntensity").value = 50;
      document.getElementById("intensityValue").innerText = "50";

      document.getElementById("editor-area").style.display = "none";
      document.getElementById("placeholder-area").style.display = "block";

      document.getElementById("templateSelect").selectedIndex = 0;
      document.getElementById("customFileName").value = "";

      if(cropper){ cropper.destroy(); cropper = null; }
      document.getElementById("work-image").src = "";

      document.querySelectorAll(".overlay-ghost").forEach(el => el.remove());

      updateDownloadState();
    }

    window.addEventListener("DOMContentLoaded", () => {
      updateDownloadState();
    });
  </script>
</body>
</html>
